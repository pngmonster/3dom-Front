{"ast":null,"code":"var _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\n// src/hooks/useMessages.ts\nimport { useState, useEffect, useCallback } from 'react';\nimport { getMessages, createMessage, getMessage } from '../api/messages';\nimport { transformMessageOut, transformMessages } from '../utils/transform';\nexport function useMessages(chatId) {\n  _s();\n  const [messages, setMessages] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n  useEffect(() => {\n    fetchMessages();\n  }, [chatId]);\n  const fetchMessages = async () => {\n    try {\n      if (!chatId) {\n        return;\n      }\n      const res = await getMessages(chatId);\n      const trans = transformMessages(res);\n      setMessages(trans);\n    } catch (err) {\n      console.error('Ошибка при получении чатов:', err);\n      setMessages([]);\n    } finally {\n      setLoading(false);\n    }\n  };\n  const send = useCallback(async msg => {\n    const newID = await createMessage(msg);\n    const newMsg = await getMessage(newID);\n    const newTransformed = transformMessageOut(newMsg);\n    setMessages(prev => [...prev, newTransformed]);\n    return newTransformed; // ✅ лучше использовать это, чем надеяться на messages\n  }, []);\n  return {\n    messages,\n    setMessages,\n    loading,\n    error,\n    send,\n    fetchMessages\n  };\n}\n_s(useMessages, \"0b6MivOnjgvvxaUfmHvrwD4Fs9k=\");\nexport function useStreamMessage(chatId) {\n  _s2();\n  const {\n    send\n  } = useMessages(chatId);\n  const [chunks, setChunks] = useState([]);\n  const [error, setError] = useState(null);\n  const start = useCallback(id => {\n    return new Promise((resolve, reject) => {\n      setChunks([]);\n      setError(null);\n      const buffer = [];\n      const evtSource = new EventSource(`https://giicoo.ru/api/message-service/stream?id=${encodeURIComponent(id)}`);\n      evtSource.onmessage = e => {\n        if (e.data === \"[DONE]\") {\n          evtSource.close();\n          const fullText = buffer.join('');\n          resolve(fullText); // ✅ возвращаем все чанки как одну строку\n          return;\n        }\n        buffer.push(e.data);\n        setChunks(prev => [...prev, e.data]);\n      };\n      evtSource.onerror = e => {\n        setError('Stream error');\n        evtSource.close();\n        reject(new Error('Stream error'));\n      };\n    });\n  }, []);\n  return {\n    chunks,\n    error,\n    start\n  };\n}\n_s2(useStreamMessage, \"u1NFL3DdXPEPR0stFcOCMFg3aSE=\", false, function () {\n  return [useMessages];\n});","map":{"version":3,"names":["useState","useEffect","useCallback","getMessages","createMessage","getMessage","transformMessageOut","transformMessages","useMessages","chatId","_s","messages","setMessages","loading","setLoading","error","setError","fetchMessages","res","trans","err","console","send","msg","newID","newMsg","newTransformed","prev","useStreamMessage","_s2","chunks","setChunks","start","id","Promise","resolve","reject","buffer","evtSource","EventSource","encodeURIComponent","onmessage","e","data","close","fullText","join","push","onerror","Error"],"sources":["/home/giicoo/projects/3DOM FRONT/3dom-Front/src/hooks/useMessages.ts"],"sourcesContent":["// src/hooks/useMessages.ts\nimport { useState, useEffect, useCallback } from 'react';\nimport {\n  getMessages,\n  createMessage,\n  getMessage,\n} from '../api/messages';\nimport { MessageIn, MessageOut } from '../api/types';\nimport { Message } from '../types';\nimport { transformMessageOut, transformMessages } from '../utils/transform';\n\nexport function useMessages(chatId: string | null) {\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [loading, setLoading] = useState<boolean>(false);\n  const [error, setError] = useState<string | null>(null);\n  \n\n  useEffect(() => {\n    fetchMessages()\n  }, [chatId]);\n\n  const fetchMessages = async () => {\n      try {\n        if (!chatId) { return; }\n        const res = await getMessages(chatId);\n        const trans = transformMessages(res)\n        setMessages(trans);\n\n      } catch (err) {\n        console.error('Ошибка при получении чатов:', err);\n        setMessages([]);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    const send = useCallback(\n      async (msg: MessageIn) => {\n        const newID = await createMessage(msg);\n        const newMsg = await getMessage(newID);\n        const newTransformed = transformMessageOut(newMsg);\n    \n        setMessages(prev => [...prev, newTransformed]);\n    \n        return newTransformed; // ✅ лучше использовать это, чем надеяться на messages\n      },\n      []\n    );\n\n  return { messages, setMessages, loading, error, send, fetchMessages};\n}\n\n\nexport function useStreamMessage(chatId: string | null) {\n  const { send } = useMessages(chatId);\n  const [chunks, setChunks] = useState<string[]>([]);\n  const [error, setError] = useState<string | null>(null);\n\n  const start = useCallback(\n    (id: string): Promise<string> => {\n      return new Promise((resolve, reject) => {\n        setChunks([]);\n        setError(null);\n\n        const buffer: string[] = [];\n\n        const evtSource = new EventSource(\n          `https://giicoo.ru/api/message-service/stream?id=${encodeURIComponent(id)}`\n        );\n\n        evtSource.onmessage = e => {\n          if (e.data === \"[DONE]\") {\n            evtSource.close();\n            const fullText = buffer.join('');\n            resolve(fullText); // ✅ возвращаем все чанки как одну строку\n            return;\n          }\n\n          buffer.push(e.data);\n          setChunks(prev => [...prev, e.data]);\n        };\n\n        evtSource.onerror = e => {\n          setError('Stream error');\n          evtSource.close();\n          reject(new Error('Stream error'));\n        };\n      });\n    },\n    []\n  );\n\n  return { chunks, error, start };\n}\n"],"mappings":";;AAAA;AACA,SAASA,QAAQ,EAAEC,SAAS,EAAEC,WAAW,QAAQ,OAAO;AACxD,SACEC,WAAW,EACXC,aAAa,EACbC,UAAU,QACL,iBAAiB;AAGxB,SAASC,mBAAmB,EAAEC,iBAAiB,QAAQ,oBAAoB;AAE3E,OAAO,SAASC,WAAWA,CAACC,MAAqB,EAAE;EAAAC,EAAA;EACjD,MAAM,CAACC,QAAQ,EAAEC,WAAW,CAAC,GAAGZ,QAAQ,CAAY,EAAE,CAAC;EACvD,MAAM,CAACa,OAAO,EAAEC,UAAU,CAAC,GAAGd,QAAQ,CAAU,KAAK,CAAC;EACtD,MAAM,CAACe,KAAK,EAAEC,QAAQ,CAAC,GAAGhB,QAAQ,CAAgB,IAAI,CAAC;EAGvDC,SAAS,CAAC,MAAM;IACdgB,aAAa,CAAC,CAAC;EACjB,CAAC,EAAE,CAACR,MAAM,CAAC,CAAC;EAEZ,MAAMQ,aAAa,GAAG,MAAAA,CAAA,KAAY;IAC9B,IAAI;MACF,IAAI,CAACR,MAAM,EAAE;QAAE;MAAQ;MACvB,MAAMS,GAAG,GAAG,MAAMf,WAAW,CAACM,MAAM,CAAC;MACrC,MAAMU,KAAK,GAAGZ,iBAAiB,CAACW,GAAG,CAAC;MACpCN,WAAW,CAACO,KAAK,CAAC;IAEpB,CAAC,CAAC,OAAOC,GAAG,EAAE;MACZC,OAAO,CAACN,KAAK,CAAC,6BAA6B,EAAEK,GAAG,CAAC;MACjDR,WAAW,CAAC,EAAE,CAAC;IACjB,CAAC,SAAS;MACRE,UAAU,CAAC,KAAK,CAAC;IACnB;EACF,CAAC;EAED,MAAMQ,IAAI,GAAGpB,WAAW,CACtB,MAAOqB,GAAc,IAAK;IACxB,MAAMC,KAAK,GAAG,MAAMpB,aAAa,CAACmB,GAAG,CAAC;IACtC,MAAME,MAAM,GAAG,MAAMpB,UAAU,CAACmB,KAAK,CAAC;IACtC,MAAME,cAAc,GAAGpB,mBAAmB,CAACmB,MAAM,CAAC;IAElDb,WAAW,CAACe,IAAI,IAAI,CAAC,GAAGA,IAAI,EAAED,cAAc,CAAC,CAAC;IAE9C,OAAOA,cAAc,CAAC,CAAC;EACzB,CAAC,EACD,EACF,CAAC;EAEH,OAAO;IAAEf,QAAQ;IAAEC,WAAW;IAAEC,OAAO;IAAEE,KAAK;IAAEO,IAAI;IAAEL;EAAa,CAAC;AACtE;AAACP,EAAA,CAvCeF,WAAW;AA0C3B,OAAO,SAASoB,gBAAgBA,CAACnB,MAAqB,EAAE;EAAAoB,GAAA;EACtD,MAAM;IAAEP;EAAK,CAAC,GAAGd,WAAW,CAACC,MAAM,CAAC;EACpC,MAAM,CAACqB,MAAM,EAAEC,SAAS,CAAC,GAAG/B,QAAQ,CAAW,EAAE,CAAC;EAClD,MAAM,CAACe,KAAK,EAAEC,QAAQ,CAAC,GAAGhB,QAAQ,CAAgB,IAAI,CAAC;EAEvD,MAAMgC,KAAK,GAAG9B,WAAW,CACtB+B,EAAU,IAAsB;IAC/B,OAAO,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;MACtCL,SAAS,CAAC,EAAE,CAAC;MACbf,QAAQ,CAAC,IAAI,CAAC;MAEd,MAAMqB,MAAgB,GAAG,EAAE;MAE3B,MAAMC,SAAS,GAAG,IAAIC,WAAW,CAC/B,mDAAmDC,kBAAkB,CAACP,EAAE,CAAC,EAC3E,CAAC;MAEDK,SAAS,CAACG,SAAS,GAAGC,CAAC,IAAI;QACzB,IAAIA,CAAC,CAACC,IAAI,KAAK,QAAQ,EAAE;UACvBL,SAAS,CAACM,KAAK,CAAC,CAAC;UACjB,MAAMC,QAAQ,GAAGR,MAAM,CAACS,IAAI,CAAC,EAAE,CAAC;UAChCX,OAAO,CAACU,QAAQ,CAAC,CAAC,CAAC;UACnB;QACF;QAEAR,MAAM,CAACU,IAAI,CAACL,CAAC,CAACC,IAAI,CAAC;QACnBZ,SAAS,CAACJ,IAAI,IAAI,CAAC,GAAGA,IAAI,EAAEe,CAAC,CAACC,IAAI,CAAC,CAAC;MACtC,CAAC;MAEDL,SAAS,CAACU,OAAO,GAAGN,CAAC,IAAI;QACvB1B,QAAQ,CAAC,cAAc,CAAC;QACxBsB,SAAS,CAACM,KAAK,CAAC,CAAC;QACjBR,MAAM,CAAC,IAAIa,KAAK,CAAC,cAAc,CAAC,CAAC;MACnC,CAAC;IACH,CAAC,CAAC;EACJ,CAAC,EACD,EACF,CAAC;EAED,OAAO;IAAEnB,MAAM;IAAEf,KAAK;IAAEiB;EAAM,CAAC;AACjC;AAACH,GAAA,CAxCeD,gBAAgB;EAAA,QACbpB,WAAW;AAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}